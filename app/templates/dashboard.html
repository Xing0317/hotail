{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- 顶部卡片信息 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">总房间数</h5>
                    <h2 class="card-text">{{ room_stats.total }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">可用房间</h5>
                    <h2 class="card-text">{{ room_stats.available }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">已入住</h5>
                    <h2 class="card-text">{{ room_stats.occupied }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">入住率</h5>
                    <h2 class="card-text">{{ room_stats.rate }}%</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- 房间过滤 -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0">房间过滤</h5>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-secondary me-2" id="viewAllRooms">查看全部</button>
                    <button class="btn btn-sm btn-outline-success me-2" id="viewAvailableRooms">查看可用</button>
                    <button class="btn btn-sm btn-outline-danger" id="viewOccupiedRooms">查看已入住</button>
                </div>
            </div>
        </div>
        <div class="card-body p-3">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">楼层</label>
                    <select class="form-select form-select-sm" id="floorFilter">
                        <option value="">全部楼层</option>
                        <option value="1">1楼</option>
                        <option value="2">2楼</option>
                        <option value="3">3楼</option>
                        <option value="4">4楼</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">房型</label>
                    <select class="form-select form-select-sm" id="typeFilter">
                        <option value="">所有类型</option>
                        <option value="daily">按天</option>
                        <option value="hourly">按小时</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">价格范围</label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="minPrice" placeholder="最低">
                        <span class="input-group-text">-</span>
                        <input type="number" class="form-control" id="maxPrice" placeholder="最高">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">房号</label>
                    <input type="text" class="form-control form-control-sm" id="roomNumberSearch" placeholder="输入房号">
                </div>
            </div>
        </div>
    </div>

    <!-- 房态图 -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">房态一览表</h5>
        </div>
        <div class="card-body p-3">
            <div class="room-status-legend mb-3">
                <span class="badge bg-success p-2 me-2">可用</span>
                <span class="badge bg-danger p-2 me-2">已入住</span>
            </div>
            
            <div class="room-grid">
                {% for floor in floors %}
                <div class="floor-section mb-4">
                    <h5 class="floor-title">{{ floor.floor_number }}楼</h5>
                    <div class="row g-3">
                        {% for room in floor.rooms %}
                        <div class="col-lg-2 col-md-3 col-sm-4 room-item" 
                             data-room="{{ room.room_number }}" 
                             data-floor="{{ floor.floor_number }}"
                             data-type="{{ room.room_type }}"
                             data-price="{{ room.price }}"
                             data-status="{{ room.status }}">
                            <div class="card room-card h-100 {{ 'border-success' if room.status == 'available' else 'border-danger' if room.status == 'occupied' else 'border-warning' }}">
                                <div class="card-header {{ 'bg-success text-white' if room.status == 'available' else 'bg-danger text-white' if room.status == 'occupied' else 'bg-warning' }} d-flex justify-content-between align-items-center">
                                    <strong>{{ room.room_number }}</strong>
                                    <span class="badge {{ 'bg-light text-dark' if room.status == 'available' or room.status == 'occupied' else 'bg-dark' }}">
                                        {{ room.room_type_display }}
                                    </span>
                                </div>
                                <div class="card-body p-2">
                                    <div class="room-info">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>价格:</span>
                                            <strong>¥{{ room.price }}</strong>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>状态:</span>
                                            <strong>{{ room.status_display }}</strong>
                                        </div>
                                    </div>
                                    
                                    {% if room.status == 'available' %}
                                    <button onclick="quickCheckIn('{{ room.room_number }}')" class="btn btn-sm btn-success w-100 mt-2">
                                        一键入住
                                    </button>
                                    {% elif room.status == 'occupied' %}
                                    <button onclick="roomDetail('{{ room.room_number }}')" class="btn btn-sm btn-outline-secondary w-100 mt-2">
                                        查看详情
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 快速入住模态框 -->
<div class="modal fade" id="quickCheckInModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">快速入住 - 房间 <span id="selectedRoom"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickCheckInForm">
                    <input type="hidden" name="room_number" id="quickRoomNumber">
                    <input type="hidden" name="room_type" id="quickRoomType">
                    <input type="hidden" name="price" id="quickRoomPrice">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">客人姓名</label>
                            <input type="text" class="form-control" name="guest_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">手机号码</label>
                            <input type="tel" class="form-control" name="phone" required pattern="[0-9]{11}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">身份证号</label>
                            <input type="text" class="form-control" name="id_card" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">入住时长</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="duration" required min="1" value="1">
                                <span class="input-group-text" id="modalDurationUnit">天</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">费用</label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" class="form-control" name="total_price" step="0.01" readonly>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">入住时间</label>
                            <input type="text" class="form-control" id="checkInTime" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="submitQuickCheckIn()">确认入住</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 初始化变量
let quickCheckInModal;
let allRooms = [];

// 页面加载完成
document.addEventListener('DOMContentLoaded', function() {
    // 初始化模态框
    quickCheckInModal = new bootstrap.Modal(document.getElementById('quickCheckInModal'));
    
    // 收集所有房间元素
    allRooms = document.querySelectorAll('.room-item');
    
    // 设置默认当前时间
    const now = new Date();
    const formattedTime = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    document.getElementById('checkInTime').value = formattedTime;
    
    // 绑定过滤器事件
    document.getElementById('floorFilter').addEventListener('change', filterRooms);
    document.getElementById('typeFilter').addEventListener('change', filterRooms);
    document.getElementById('roomNumberSearch').addEventListener('input', filterRooms);
    document.getElementById('minPrice').addEventListener('input', filterRooms);
    document.getElementById('maxPrice').addEventListener('input', filterRooms);
    
    // 快捷按钮
    document.getElementById('viewAllRooms').addEventListener('click', showAllRooms);
    document.getElementById('viewAvailableRooms').addEventListener('click', showAvailableRooms);
    document.getElementById('viewOccupiedRooms').addEventListener('click', showOccupiedRooms);
});

// 快速入住初始化
function quickCheckIn(roomNumber) {
    // 清空表单
    document.getElementById('quickCheckInForm').reset();
    
    // 设置所选房间信息
    const roomCard = document.querySelector(`.room-item[data-room="${roomNumber}"]`);
    const roomType = roomCard.dataset.type;
    const roomPrice = roomCard.dataset.price;
    
    document.getElementById('selectedRoom').textContent = roomNumber;
    document.getElementById('quickRoomNumber').value = roomNumber;
    document.getElementById('quickRoomType').value = roomType;
    document.getElementById('quickRoomPrice').value = roomPrice;
    
    // 设置单位文本
    document.getElementById('modalDurationUnit').textContent = roomType === 'hourly' ? '小时' : '天';
    
    // 设置初始价格
    document.querySelector('#quickCheckInForm input[name="total_price"]').value = roomPrice;
    
    // 绑定时长变化事件
    document.querySelector('#quickCheckInForm input[name="duration"]').addEventListener('input', calculateQuickCheckInPrice);
    
    // 显示模态框
    quickCheckInModal.show();
}

// 计算快速入住价格
function calculateQuickCheckInPrice() {
    const price = document.getElementById('quickRoomPrice').value;
    const duration = document.querySelector('#quickCheckInForm input[name="duration"]').value;
    if (price && duration) {
        const total = (parseFloat(price) * parseInt(duration)).toFixed(2);
        document.querySelector('#quickCheckInForm input[name="total_price"]').value = total;
    }
}

// 提交快速入住
function submitQuickCheckIn() {
    // 获取表单数据
    const formData = {
        guest_name: document.querySelector('#quickCheckInForm input[name="guest_name"]').value.trim(),
        phone: document.querySelector('#quickCheckInForm input[name="phone"]').value.trim(),
        id_card: document.querySelector('#quickCheckInForm input[name="id_card"]').value.trim(),
        room_number: document.getElementById('quickRoomNumber').value,
        room_type: document.getElementById('quickRoomType').value,
        price: document.getElementById('quickRoomPrice').value,
        duration: document.querySelector('#quickCheckInForm input[name="duration"]').value
    };

    // 验证数据
    for (let key in formData) {
        if (!formData[key]) {
            alert('请填写完整所有信息');
            return;
        }
    }

    // 发送请求
    fetch('/api/check-in', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('入住登记成功！');
            quickCheckInModal.hide();
            window.location.reload();
        } else {
            alert('入住登记失败：' + data.error);
        }
    })
    .catch(error => {
        alert('系统错误：' + error);
        console.error(error);
    });
}

// 查看房间详情
function roomDetail(roomNumber) {
    window.location.href = `/room-detail/${roomNumber}`;
}

// 过滤房间
function filterRooms() {
    const floor = document.getElementById('floorFilter').value;
    const type = document.getElementById('typeFilter').value;
    const roomNumber = document.getElementById('roomNumberSearch').value.toLowerCase();
    const minPrice = document.getElementById('minPrice').value;
    const maxPrice = document.getElementById('maxPrice').value;
    
    allRooms.forEach(room => {
        let show = true;
        
        // 按楼层过滤
        if (floor && room.dataset.floor !== floor) {
            show = false;
        }
        
        // 按类型过滤
        if (type && room.dataset.type !== type) {
            show = false;
        }
        
        // 按房号过滤
        if (roomNumber && !room.dataset.room.toLowerCase().includes(roomNumber)) {
            show = false;
        }
        
        // 按价格过滤
        const price = parseFloat(room.dataset.price);
        if (minPrice && price < parseFloat(minPrice)) {
            show = false;
        }
        if (maxPrice && price > parseFloat(maxPrice)) {
            show = false;
        }
        
        // 显示或隐藏
        room.style.display = show ? '' : 'none';
    });
}

// 显示所有房间
function showAllRooms() {
    document.getElementById('floorFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('roomNumberSearch').value = '';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    
    allRooms.forEach(room => {
        room.style.display = '';
    });
}

// 只显示可用房间
function showAvailableRooms() {
    showAllRooms();
    allRooms.forEach(room => {
        if (room.dataset.status !== 'available') {
            room.style.display = 'none';
        }
    });
}

// 只显示已入住房间
function showOccupiedRooms() {
    showAllRooms();
    allRooms.forEach(room => {
        if (room.dataset.status !== 'occupied') {
            room.style.display = 'none';
        }
    });
}
</script>
<style>
.room-card {
    transition: all 0.3s ease;
}
.room-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.floor-title {
    border-bottom: 2px solid #eee;
    padding-bottom: 8px;
    margin-bottom: 15px;
}
.room-grid {
    max-height: 70vh;
    overflow-y: auto;
}
</style>
{% endblock %} 